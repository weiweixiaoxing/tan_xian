<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>天地玄妙 - 农历计算器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-image: url("./backgrounds/background.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            margin: 0;
            padding: 0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        .container {
            width: 394px;
            height: 856px;
            margin: 20px auto;
            background: white;
            opacity: 0.68;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            z-index: 1;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border-radius: 20px;
        }
        
        /* 美化滚动条 */
        .container::-webkit-scrollbar {
            width: 4px;
        }
        
        .container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
        
        .container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 第一行：系统时间 */
        .time-row {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            gap: 31px;
        }
        
        .system-time {
            color: #d32f2f;
            font-weight: 600;
            font-size: 18px;
        }
        
        .laibin-time {
            color: #d32f2f;
            font-size: 14px;
        }
        
        /* 第二行：农历输出 */
        .lunar-row {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        
        .lunar-text {
            color: #333;
        }
        
        .jieqi-text {
            color: #1976d2;
            margin-left: 10px;
        }
        
        /* 第三行：干支 */
        .ganzhi-row {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 16px;
            font-size: 16px;
            color: #d32f2f;
            font-weight: 500;
            justify-content: center;
        }
        
        .ganzhi-item {
            flex: 0 0 auto;
            text-align: center;
        }
        
        /* 第四行：值星 */
        .zhixing-row {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        
        /* 第五行：输入区域 */
        .input-row {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .input-row input,
        .input-row select {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .query-btn {
            padding: 8px 16px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .query-btn:active {
            background: #1565c0;
        }
        
        /* 结果区域 */
        .result-area {
            padding: 20px;
            background: white;
        }
        
        .result-section {
            margin-bottom: 20px;
        }
        
        .result-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #333;
            padding-bottom: 8px;
            border-bottom: 2px solid #1976d2;
        }
        
        .result-item {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            color: #666;
            margin-right: 8px;
        }
        
        .result-value {
            color: #333;
            font-weight: 500;
        }
        
        .date-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #1976d2;
        }
        
        .date-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .date-detail {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .xingri-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .xingri-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .xingri-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 6px;
        }
        
        .xingri-days {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .report-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #4a90e2;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标题：天元乌兔择日 -->
        <div style="padding: 21px 20px 8px 20px; text-align: center; font-weight: bold; font-size: 20px; margin: 2px 0;">
            天元乌兔择日
        </div>
        
        <!-- 第一行：系统时间 -->
        <div class="time-row" style="padding: 5px 20px 8px 20px;">
            <span class="system-time" id="systemTime">--:--:--</span>
            <span class="laibin-time" id="laibinTime">--:--:--</span>
        </div>
        
        <!-- 第二行：农历输出 -->
        <div class="lunar-row">
            <span class="lunar-text" id="lunarText">加载中...</span>
            <span class="jieqi-text" id="jieqiText"></span>
        </div>
        
        <!-- 第三行：nz yz rz sz kz -->
        <div class="ganzhi-row" id="ganzhiRow">
            <div class="ganzhi-item">--</div>
            <div class="ganzhi-item">--</div>
            <div class="ganzhi-item">--</div>
            <div class="ganzhi-item">--</div>
            <div class="ganzhi-item">--</div>
        </div>
        
        <!-- 第四行：值日星 值时星 值刻星 -->
        <div class="zhixing-row" id="zhixingRow">
            值日星: -- 值时星: -- 值刻星: --
        </div>
        
        <!-- 第五行：星方星符信息 -->
        <div class="zhixing-row" id="xfRow">
            -- --
        </div>
        
        <!-- 第六行：太阳太阴到向到山 -->
        <div class="zhixing-row" id="tytyRow">
            -- --
        </div>
        
        <!-- 第七行：输入区域 -->
        <div class="input-row">
            <input type="number" id="cn" placeholder="年份">
            <input type="number" id="cy" placeholder="月份" min="1" max="12">
            <select id="czrx">
                <option value="">值日星</option>
                <option value="水星">水星</option>
                <option value="太阴">太阴</option>
                <option value="木星">木星</option>
                <option value="计都">计都</option>
                <option value="土星">土星</option>
                <option value="罗睺">罗睺</option>
                <option value="金星">金星</option>
                <option value="太阳">太阳</option>
                <option value="火星">火星</option>
            </select>
            <button class="query-btn" onclick="query()">查询</button>
        </div>
        
        <!-- 结果区域 -->
        <div class="result-area" id="resultArea">
            <div class="result-section">
                <div class="result-title">当月星日分布</div>
                <div id="xingriContent">加载中...</div>
            </div>
        </div>
    </div>
    
    <!-- 引入lunar-javascript库 -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@latest/dist/index.umd.min.js"></script>
    
    <script>
        // 常量定义
        const constants = {
            XINGSHU_MAP: {
                '水星': 1, '太阴': 2, '木星': 3, '计都': 4,
                '土星': 5, '罗睺': 6, '金星': 7, '太阳': 8, '火星': 9
            },
            XINGSHU_REVERSE: {
                1: '水星', 2: '太阴', 3: '木星', 4: '计都',
                5: '土星', 6: '罗睺', 7: '金星', 8: '太阳', 9: '火星'
            },
            diZhiIndex: {
                '子': 0, '丑': 1, '寅': 2, '卯': 3, '辰': 4, '巳': 5,
                '午': 6, '未': 7, '申': 8, '酉': 9, '戌': 10, '亥': 11
            },
            tianGanOrder: ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'],
            keGanzhiMap: {
                '甲己': ['甲子', '乙丑', '丙寅', '丁卯', '戊辰', '己巳', '庚午', '辛未', '壬申', '癸酉', '甲戌', '乙亥'],
                '乙庚': ['丙子', '丁丑', '戊寅', '己卯', '庚辰', '辛巳', '壬午', '癸未', '甲申', '乙酉', '丙戌', '丁亥'],
                '丙辛': ['戊子', '己丑', '庚寅', '辛卯', '壬辰', '癸巳', '甲午', '乙未', '丙申', '丁酉', '戊戌', '己亥'],
                '丁壬': ['庚子', '辛丑', '壬寅', '癸卯', '甲辰', '乙巳', '丙午', '丁未', '戊申', '己酉', '庚戌', '辛亥'],
                '戊癸': ['壬子', '癸丑', '甲寅', '乙卯', '丙辰', '丁巳', '戊午', '己未', '庚申', '辛酉', '壬戌', '癸亥']
            },
            TAIJI_GR: {
                '甲': ['子', '午'], '乙': ['子', '午'], '丙': ['卯', '酉'], '丁': ['卯', '酉'],
                '戊': ['辰', '戌', '丑', '未'], '己': ['辰', '戌', '丑', '未'],
                '庚': ['寅', '亥'], '辛': ['寅', '亥'], '壬': ['巳', '申'], '癸': ['巳', '申']
            },
            TIANYI_GR: {
                '甲': ['丑', '未'], '戊': ['丑', '未'], '庚': ['丑', '未'],
                '乙': ['子', '申'], '己': ['子', '申'],
                '丙': ['亥', '酉'], '丁': ['亥', '酉'],
                '壬': ['卯', '巳'], '癸': ['卯', '巳'], '辛': ['寅', '午']
            },
            GUOYIN_GR: {
                '甲': ['戌'], '乙': ['亥'], '丙': ['丑'], '丁': ['寅'], '戊': ['丑'], '己': ['寅'],
                '庚': ['辰'], '辛': ['巳'], '壬': ['未'], '癸': ['申']
            },
            WENCHANG_GR: {
                '甲': ['巳'], '乙': ['午'], '丙': ['申'], '丁': ['酉'], '戊': ['申'], '己': ['酉'],
                '庚': ['亥'], '辛': ['子'], '壬': ['寅'], '癸': ['卯']
            },
            FUXING_GR: {
                '甲': ['寅', '子'], '丙': ['寅', '子'], '乙': ['丑', '卯'], '癸': ['丑', '卯'],
                '戊': ['申'], '己': ['未'], '丁': ['亥'], '庚': ['午'], '辛': ['巳'], '壬': ['辰']
            },
            TIANCHU_GR: {
                '甲': ['巳'], '丙': ['巳'], '乙': ['午'], '丁': ['午'], '戊': ['申'],
                '己': ['酉'], '庚': ['亥'], '辛': ['子'], '壬': ['寅'], '癸': ['卯']
            },
            WENQU_GR: {
                '甲': ['巳'], '乙': ['午'], '丙': ['申'], '戊': ['申'], '丁': ['酉'], '己': ['酉'],
                '庚': ['亥'], '辛': ['子'], '壬': ['寅'], '癸': ['卯']
            },
            JIEDU_GR: {
                '甲': ['巳'], '丙': ['巳'], '戊': ['巳'], '乙': ['未'], '丁': ['未'], '己': ['未'],
                '庚': ['亥'], '壬': ['亥'], '辛': ['丑'], '癸': ['丑']
            },
            DTJS_MAP: {
                '甲己': ['辰', '巳', '巽'], '乙庚': ['子寅', '丑卯', '甲'],
                '丙辛': ['戌', '亥', '乾'], '丁壬': ['申', '酉', '庚'], '戊癸': ['午', '未', '丁']
            },
            GAN_YIN_YANG: {
                '甲': '阳', '己': '阳', '丁': '阳', '壬': '阳', '戊': '阳', '癸': '阳',
                '乙': '阴', '庚': '阴', '丙': '阴', '辛': '阴'
            },
            XINGZHI: {
                '子': 1, '未': 2, '申': 2, '卯': 3, '辰': 4, '巳': 4,
                '戌': 6, '亥': 6, '酉': 7, '丑': 8, '寅': 8, '午': 9
            },
            DZ12: ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'],
            DZSX: ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'],
            DZNX: ['子', '亥', '戌', '酉', '申', '未', '午', '巳', '辰', '卯', '寅', '丑'],
            PAISHANZ: [1, 2, 3, 4, 5, 6, 7, 8, 9],
            QIXING: {
                '甲': [1, 2, 3, 4, 5, 6, 7, 8, 9], '己': [1, 2, 3, 4, 5, 6, 7, 8, 9],
                '乙': [7, 6, 5, 4, 3, 2, 1, 9, 8], '庚': [7, 6, 5, 4, 3, 2, 1, 9, 8],
                '丙': [3, 2, 1, 9, 8, 7, 6, 5, 4], '辛': [3, 2, 1, 9, 8, 7, 6, 5, 4],
                '丁': [9, 1, 2, 3, 4, 5, 6, 7, 8], '壬': [9, 1, 2, 3, 4, 5, 6, 7, 8],
                '戊': [5, 6, 7, 8, 9, 1, 2, 3, 4], '癸': [5, 6, 7, 8, 9, 1, 2, 3, 4]
            },
            MONTH_KEYS: ['yi', 'er', 'san', 'si', 'wu', 'liu', 'qi', 'ba', 'jiu', 'shi', 'shiyi', 'shier'],
            MONTH_NAMES: ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '十一', '十二'],
            LIU_SHI_JIA_ZI: [
                "甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉",
                "甲戌", "乙亥", "丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未",
                "甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳",
                "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑", "壬寅", "癸卯",
                "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑",
                "甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"
            ],
            LSHIB: {
                '子': '艮', '丑': '艮', '寅': '巽', '卯': '巽', '辰': '巽',
                '巳': '坤', '午': '坤', '未': '坤', '申': '乾', '酉': '乾', '戌': '乾', '亥': '艮'
            },
            ANJIAN1: {
                '子午卯酉': ['坤', '震', '巽', '中', '乾', '兑', '艮', '离', '坎', '坤', '震', '巽'],
                '寅申巳亥': ['艮', '离', '坎', '坤', '震', '巽', '中', '乾', '兑', '艮', '离', '坎'],
                '辰戌丑未': ['中', '乾', '兑', '艮', '离', '坎', '坤', '震', '巽', '中', '乾', '兑']
            },
            ZHIXING_MAP: {
                1: '水星', 2: '太阴', 3: '木星', 4: '计都', 5: '土星', 6: '罗睺', 7: '金星', 8: '太阳', 9: '火星'
            }
        };
        
        // 星方计算函数
        function get_xingfang_info(jieqi, ri_gan_zhi) {
            const XINGFANG_MAP = {
                '立春': {'巽': '火', '离': '土', '坤': '金', '兑': '水', '乾': '木', '坎': '火', '艮': '土', '震': '金'},
                '雨水': {'巽': '土', '离': '金', '坤': '水', '兑': '木', '乾': '火', '坎': '土', '艮': '金', '震': '水'},
                '惊蛰': {'巽': '金', '离': '水', '坤': '木', '兑': '火', '乾': '土', '坎': '金', '艮': '水', '震': '木'},
                '春分': {'巽': '水', '离': '木', '坤': '火', '兑': '土', '乾': '金', '坎': '水', '艮': '木', '震': '火'},
                '清明': {'巽': '木', '离': '火', '坤': '土', '兑': '金', '乾': '水', '坎': '木', '艮': '火', '震': '土'},
                '谷雨': {'巽': '火', '离': '土', '坤': '金', '兑': '水', '乾': '木', '坎': '火', '艮': '土', '震': '金'},
                '立夏': {'巽': '土', '离': '金', '坤': '水', '兑': '木', '乾': '火', '坎': '土', '艮': '金', '震': '水'},
                '小满': {'巽': '金', '离': '水', '坤': '木', '兑': '火', '乾': '土', '坎': '金', '艮': '水', '震': '木'},
                '芒种': {'巽': '水', '离': '木', '坤': '火', '兑': '土', '乾': '金', '坎': '水', '艮': '木', '震': '火'},
                '夏至': {'巽': '木', '离': '火', '坤': '土', '兑': '金', '乾': '水', '坎': '木', '艮': '火', '震': '土'},
                '小暑': {'巽': '火', '离': '土', '坤': '金', '兑': '水', '乾': '木', '坎': '火', '艮': '土', '震': '金'},
                '大暑': {'巽': '土', '离': '金', '坤': '水', '兑': '木', '乾': '火', '坎': '土', '艮': '金', '震': '水'},
                '立秋': {'巽': '金', '离': '水', '坤': '木', '兑': '火', '乾': '土', '坎': '金', '艮': '水', '震': '木'},
                '处暑': {'巽': '水', '离': '木', '坤': '火', '兑': '土', '乾': '金', '坎': '水', '艮': '木', '震': '火'},
                '白露': {'巽': '木', '离': '火', '坤': '土', '兑': '金', '乾': '水', '坎': '木', '艮': '火', '震': '土'},
                '秋分': {'巽': '火', '离': '土', '坤': '金', '兑': '水', '乾': '木', '坎': '火', '艮': '土', '震': '金'},
                '寒露': {'巽': '土', '离': '金', '坤': '水', '兑': '木', '乾': '火', '坎': '土', '艮': '金', '震': '水'},
                '霜降': {'巽': '金', '离': '水', '坤': '木', '兑': '火', '乾': '土', '坎': '金', '艮': '水', '震': '木'},
                '立冬': {'巽': '水', '离': '木', '坤': '火', '兑': '土', '乾': '金', '坎': '水', '艮': '木', '震': '火'},
                '小雪': {'巽': '木', '离': '火', '坤': '土', '兑': '金', '乾': '水', '坎': '木', '艮': '火', '震': '土'},
                '大雪': {'巽': '火', '离': '土', '坤': '金', '兑': '水', '乾': '木', '坎': '火', '艮': '土', '震': '金'},
                '冬至': {'巽': '土', '离': '金', '坤': '水', '兑': '木', '乾': '火', '坎': '土', '艮': '金', '震': '水'},
                '小寒': {'巽': '金', '离': '水', '坤': '木', '兑': '火', '乾': '土', '坎': '金', '艮': '水', '震': '木'},
                '大寒': {'巽': '水', '离': '木', '坤': '火', '兑': '土', '乾': '金', '坎': '水', '艮': '木', '震': '火'}
            };
            
            const XINGF_MAP = {
                '甲': {'震': '水', '巽': '金', '离': '土', '坤': '木', '兑': '火'},
                '乙': {'震': '金', '巽': '水', '离': '火', '坤': '土', '兑': '木'},
                '丙': {'震': '土', '巽': '火', '离': '木', '坤': '水', '兑': '金'},
                '丁': {'震': '木', '巽': '土', '离': '金', '坤': '火', '兑': '水'},
                '戊': {'震': '火', '巽': '木', '离': '水', '坤': '金', '兑': '土'},
                '己': {'震': '水', '巽': '金', '离': '土', '坤': '木', '兑': '火'},
                '庚': {'震': '金', '巽': '水', '离': '火', '坤': '土', '兑': '木'},
                '辛': {'震': '土', '巽': '火', '离': '木', '坤': '水', '兑': '金'},
                '壬': {'震': '木', '巽': '土', '离': '金', '坤': '火', '兑': '水'},
                '癸': {'震': '火', '巽': '木', '离': '水', '坤': '金', '兑': '土'}
            };
            
            if (!jieqi || !XINGFANG_MAP[jieqi] || !ri_gan_zhi) {
                return { xingfang: null, xingf: null };
            }
            
            const xingfang = XINGFANG_MAP[jieqi];
            const gan = ri_gan_zhi[0];
            const xingf = XINGF_MAP[gan] || null;
            
            return { xingfang: xingfang, xingf: xingf };
        }
        
        // 太阳太阴到向到山计算
        function get_tyty_info(jieqi) {
            const TYTY_MAP = {
                '立春': { taiyangdx: '太阳到艮', taiyinds: '太阴到坤' },
                '雨水': { taiyangdx: '太阳到寅', taiyinds: '太阴到申' },
                '惊蛰': { taiyangdx: '太阳到甲', taiyinds: '太阴到庚' },
                '春分': { taiyangdx: '太阳到震', taiyinds: '太阴到兑' },
                '清明': { taiyangdx: '太阳到乙', taiyinds: '太阴到辛' },
                '谷雨': { taiyangdx: '太阳到卯', taiyinds: '太阴到酉' },
                '立夏': { taiyangdx: '太阳到巽', taiyinds: '太阴到乾' },
                '小满': { taiyangdx: '太阳到辰', taiyinds: '太阴到戌' },
                '芒种': { taiyangdx: '太阳到巳', taiyinds: '太阴到亥' },
                '夏至': { taiyangdx: '太阳到离', taiyinds: '太阴到坎' },
                '小暑': { taiyangdx: '太阳到丙', taiyinds: '太阴到壬' },
                '大暑': { taiyangdx: '太阳到午', taiyinds: '太阴到子' },
                '立秋': { taiyangdx: '太阳到丁', taiyinds: '太阴到癸' },
                '处暑': { taiyangdx: '太阳到未', taiyinds: '太阴到丑' },
                '白露': { taiyangdx: '太阳到坤', taiyinds: '太阴到艮' },
                '秋分': { taiyangdx: '太阳到申', taiyinds: '太阴到寅' },
                '寒露': { taiyangdx: '太阳到庚', taiyinds: '太阴到甲' },
                '霜降': { taiyangdx: '太阳到兑', taiyinds: '太阴到震' },
                '立冬': { taiyangdx: '太阳到辛', taiyinds: '太阴到乙' },
                '小雪': { taiyangdx: '太阳到酉', taiyinds: '太阴到卯' },
                '大雪': { taiyangdx: '太阳到乾', taiyinds: '太阴到巽' },
                '冬至': { taiyangdx: '太阳到坎', taiyinds: '太阴到离' },
                '小寒': { taiyangdx: '太阳到壬', taiyinds: '太阴到丙' },
                '大寒': { taiyangdx: '太阳到子', taiyinds: '太阴到午' }
            };
            
            return TYTY_MAP[jieqi] || { taiyangdx: null, taiyinds: null };
        }
        
        // 工具函数
        function get_valid_number(value) {
            if (typeof value !== 'number' || value <= 0) {
                return null;
            }
            return value;
        }
        
        function get_dtjs_group_by_gan(gan) {
            if (!gan) {
                return null;
            }
            if (gan === '甲' || gan === '己') {
                return constants.DTJS_MAP['甲己'];
            }
            if (gan === '乙' || gan === '庚') {
                return constants.DTJS_MAP['乙庚'];
            }
            if (gan === '丙' || gan === '辛') {
                return constants.DTJS_MAP['丙辛'];
            }
            if (gan === '丁' || gan === '壬') {
                return constants.DTJS_MAP['丁壬'];
            }
            if (gan === '戊' || gan === '癸') {
                return constants.DTJS_MAP['戊癸'];
            }
            return null;
        }
        
        function calculate_cyxing(m, d) {
            if (!m || !d || (m !== '阳' && m !== '阴')) {
                return null;
            }
            const zhi = (m === '阳' ? constants.DZSX : constants.DZNX)[(d - 1) % 12];
            return constants.XINGZHI[zhi];
        }
        
        function calculate_xingri(cyxing, chuyigzyy, yts) {
            if (cyxing === null || !chuyigzyy || !yts || (chuyigzyy !== '阳' && chuyigzyy !== '阴') || !constants.PAISHANZ.includes(cyxing)) {
                return null;
            }
            const idx = constants.PAISHANZ.indexOf(cyxing);
            let rearranged;
            if (chuyigzyy === '阳') {
                rearranged = constants.PAISHANZ.slice(idx).concat(constants.PAISHANZ.slice(0, idx));
            } else {
                const reversed_list = [...constants.PAISHANZ].reverse();
                const rev_idx = reversed_list.indexOf(cyxing);
                rearranged = reversed_list.slice(rev_idx).concat(reversed_list.slice(0, rev_idx));
            }
            
            const result = {};
            for (let idx = 0; idx < rearranged.length; idx++) {
                const num = rearranged[idx];
                const days = [];
                const max_iterations = Math.ceil(yts / 9);
                for (let i = 0; i < max_iterations; i++) {
                    const day = idx + 1 + i * 9;
                    if (day <= yts) {
                        days.push(day);
                    }
                }
                if (days.length > 0) {
                    result[num] = days;
                }
            }
            return result;
        }
        
        function find_last_mao_day(start_lunar) {
            const start_solar = start_lunar.getSolar();
            for (let i = 1; i <= 60; i++) {
                const prev_solar = start_solar.next(-i);
                const prev_lunar = prev_solar.getLunar();
                if (prev_lunar.getDayZhi() === '卯') {
                    return prev_lunar;
                }
            }
            throw new Error('未找到卯日');
        }
        
        function calculate_gan_group(gan_zhi) {
            if (!gan_zhi || gan_zhi.length < 1) {
                return null;
            }
            const gan = gan_zhi[0];
            if (!constants.QIXING[gan]) {
                return null;
            }
            const seq = constants.QIXING[gan];
            const result = {};
            for (let i = 0; i < constants.DZ12.length; i++) {
                const zhi = constants.DZ12[i];
                const num = seq[i % 9];
                if (!result[num]) {
                    result[num] = [];
                }
                result[num].push(zhi);
            }
            return result;
        }
        
        function calculate_xingshi(rz) {
            return calculate_gan_group(rz);
        }
        
        function calculate_xingke(sz) {
            return calculate_gan_group(sz);
        }
        
        function get_jieqi(lunar) {
            try {
                const jq = lunar.getJieQi();
                if (jq) {
                    return jq.getName();
                }
            } catch (e) {
                // 忽略错误
            }
            try {
                const jq = lunar.getPrevJieQi();
                if (jq) {
                    return jq.getName();
                }
            } catch (e) {
                // 忽略错误
            }
            try {
                const jq = lunar.getNextJieQi();
                if (jq) {
                    return jq.getName();
                }
            } catch (e) {
                // 忽略错误
            }
            return null;
        }
        
        function get_corrected_time(date) {
            const longitude = 109.2;
            const time_diff_minutes = (longitude - 120) * 4;
            return new Date(date.getTime() + time_diff_minutes * 60 * 1000);
        }
        
        function format_date(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}年${month}月${day}日 ${hours}:${minutes}:${seconds}`;
        }
        
        function calculate_ke_gan_zhi(now_lunar, now) {
            try {
                const corrected_time = get_corrected_time(now);
                const corrected_solar = lunar.Solar.fromDate(corrected_time);
                const corrected_lunar = corrected_solar.getLunar();
                const shi_gan_zhi = corrected_lunar.getTimeInGanZhi();
                if (!shi_gan_zhi) {
                    return { kz: null, kezhi: null, kg: null };
                }
                
                const shi_gan = shi_gan_zhi[0];
                const h = corrected_time.getHours();
                const m = corrected_time.getMinutes();
                const total_minutes = h * 60 + m;
                
                const time_periods = [
                    { name: '子时', start: 23 * 60, end: 1 * 60 },
                    { name: '丑时', start: 1 * 60, end: 3 * 60 },
                    { name: '寅时', start: 3 * 60, end: 5 * 60 },
                    { name: '卯时', start: 5 * 60, end: 7 * 60 },
                    { name: '辰时', start: 7 * 60, end: 9 * 60 },
                    { name: '巳时', start: 9 * 60, end: 11 * 60 },
                    { name: '午时', start: 11 * 60, end: 13 * 60 },
                    { name: '未时', start: 13 * 60, end: 15 * 60 },
                    { name: '申时', start: 15 * 60, end: 17 * 60 },
                    { name: '酉时', start: 17 * 60, end: 19 * 60 },
                    { name: '戌时', start: 19 * 60, end: 21 * 60 },
                    { name: '亥时', start: 21 * 60, end: 23 * 60 }
                ];
                
                let minutes_in_period = 0;
                let found = false;
                for (const p of time_periods) {
                    if ((p.start <= p.end && p.start <= total_minutes < p.end) || 
                        (p.start > p.end && (total_minutes >= p.start || total_minutes < p.end))) {
                        minutes_in_period = (total_minutes - p.start + 24 * 60) % (24 * 60);
                        found = true;
                        break;
                    }
                }
                
                if (!found) {
                    throw new Error('未找到对应时辰');
                }
                
                let effective_gan = shi_gan;
                if (minutes_in_period >= 115) {
                    const idx = constants.tianGanOrder.indexOf(effective_gan);
                    effective_gan = constants.tianGanOrder[(idx + 1 + constants.tianGanOrder.length) % constants.tianGanOrder.length];
                }
                
                const ke_periods = [
                    { name: '子', start: 115, end: 5 },
                    { name: '丑', start: 5, end: 15 },
                    { name: '寅', start: 15, end: 25 },
                    { name: '卯', start: 25, end: 35 },
                    { name: '辰', start: 35, end: 45 },
                    { name: '巳', start: 45, end: 55 },
                    { name: '午', start: 55, end: 65 },
                    { name: '未', start: 65, end: 75 },
                    { name: '申', start: 75, end: 85 },
                    { name: '酉', start: 85, end: 95 },
                    { name: '戌', start: 95, end: 105 },
                    { name: '亥', start: 105, end: 115 }
                ];
                
                const adj = minutes_in_period % 120;
                let ke_zhi = null;
                for (const k of ke_periods) {
                    if ((k.start <= k.end && k.start <= adj < k.end) || 
                        (k.start > k.end && (adj >= k.start || adj < k.end))) {
                        ke_zhi = k.name;
                        break;
                    }
                }
                
                if (!ke_zhi) {
                    throw new Error('未找到对应刻地支');
                }
                
                let gan_key = null;
                if (effective_gan === '甲' || effective_gan === '己') {
                    gan_key = '甲己';
                } else if (effective_gan === '乙' || effective_gan === '庚') {
                    gan_key = '乙庚';
                } else if (effective_gan === '丙' || effective_gan === '辛') {
                    gan_key = '丙辛';
                } else if (effective_gan === '丁' || effective_gan === '壬') {
                    gan_key = '丁壬';
                } else if (effective_gan === '戊' || effective_gan === '癸') {
                    gan_key = '戊癸';
                } else {
                    throw new Error('无效天干');
                }
                
                const idx = constants.diZhiIndex[ke_zhi];
                const ke_gan_zhi = constants.keGanzhiMap[gan_key][idx];
                return {
                    kz: ke_gan_zhi,
                    kezhi: ke_gan_zhi.length > 1 ? ke_gan_zhi[1] : null,
                    kg: ke_gan_zhi.length > 0 ? ke_gan_zhi[0] : null
                };
            } catch (e) {
                return { kz: null, kezhi: null, kg: null };
            }
        }
        
        function calculate_lishi(nz) {
            if (!nz || nz.length < 2) {
                return null;
            }
            const zhi = nz[1];
            if (!constants.LSHIB[zhi]) {
                return null;
            }
            const fang = constants.LSHIB[zhi];
            return `${zhi}年力士在${fang}方`;
        }
        
        function calculate_whajs(nz) {
            if (!nz || nz.length < 2) {
                return null;
            }
            const zhi = nz[1];
            let group;
            if (zhi === '子' || zhi === '午' || zhi === '卯' || zhi === '酉') {
                group = '子午卯酉';
            } else if (zhi === '寅' || zhi === '申' || zhi === '巳' || zhi === '亥') {
                group = '寅申巳亥';
            } else if (zhi === '辰' || zhi === '戌' || zhi === '丑' || zhi === '未') {
                group = '辰戌丑未';
            } else {
                return null;
            }
            
            if (!constants.ANJIAN1[group]) {
                return null;
            }
            
            const seq = constants.ANJIAN1[group];
            const out = {};
            for (let i = 0; i < 12; i++) {
                const key = constants.MONTH_KEYS[i];
                out[key] = `${constants.MONTH_NAMES[i]}月暗建煞在${seq[i]}`;
            }
            return out;
        }
        
        function calculate_all_guiren(nz, now_lunar) {
            if (!nz || nz.length < 1) {
                return null;
            }
            
            const gan = nz[0];
            const year = now_lunar.getYear();
            const month = now_lunar.getMonth();
            const is_leap = month < 0;
            
            if (!year || !month) {
                return null;
            }
            
            const abs_month = Math.abs(month);
            try {
                const lunar_year = lunar.LunarYear.fromYear(year);
                const lunar_month = lunar_year.getMonth(abs_month);
                const days = lunar_month.getDayCount();
                if (days <= 0) {
                    return null;
                }
                
                const first_day = lunar.Lunar.fromYmd(year, abs_month, 1, is_leap);
                const first_day_gz = first_day.getDayInGanZhi();
                const first_idx = constants.LIU_SHI_JIA_ZI.indexOf(first_day_gz);
                if (first_idx === -1) {
                    return null;
                }
                
                const month_days_gz = {};
                for (let d = 1; d <= days; d++) {
                    const idx = (first_idx + d - 1) % 60;
                    const gz = constants.LIU_SHI_JIA_ZI[idx];
                    month_days_gz[d] = {
                        gz: gz,
                        zhi: gz.length > 1 ? gz[1] : ''
                    };
                }
                
                const guiren_configs = [
                    ['taijiguiren', constants.TAIJI_GR],
                    ['tianyiguiren', constants.TIANYI_GR],
                    ['guoyinguiren', constants.GUOYIN_GR],
                    ['wenchangguiren', constants.WENCHANG_GR],
                    ['fuxingguiren', constants.FUXING_GR],
                    ['tianchuguiren', constants.TIANCHU_GR],
                    ['wenquguiren', constants.WENQU_GR],
                    ['jieduguiren', constants.JIEDU_GR]
                ];
                
                const result = {};
                let has_any = false;
                for (const [key, gr_map] of guiren_configs) {
                    if (!gr_map[gan]) {
                        result[key] = null;
                        continue;
                    }
                    const gr_zhi_list = gr_map[gan];
                    const list_result = Object.entries(month_days_gz)
                        .filter(([day, v]) => gr_zhi_list.includes(v.zhi))
                        .map(([day, v]) => ({
                            day: parseInt(day),
                            gz: v.gz
                        }));
                    result[key] = list_result.length > 0 ? list_result : null;
                    if (list_result.length > 0) {
                        has_any = true;
                    }
                }
                
                return has_any ? result : null;
            } catch (e) {
                return null;
            }
        }
        
        function calculate_month_info(year, month, is_leap, czrx, czsx, whajs, shaf) {
            const czrx_num = constants.XINGSHU_MAP[czrx];
            const czsx_num = constants.XINGSHU_MAP[czsx];
            
            let cxingzhiri = null;
            const cxingzhiri_detail = {};
            
            try {
                const month_for_date = is_leap ? -month : month;
                const lunar_month_obj = lunar.LunarYear.fromYear(year).getMonth(month);
                const days = lunar_month_obj ? lunar_month_obj.getDayCount() : 0;
                
                if (days > 0) {
                    const first_day = lunar.Lunar.fromYmd(year, month_for_date, 1);
                    const mao_day = find_last_mao_day(first_day);
                    const chuyigz = first_day.getDayInGanZhi();
                    const mgz = mao_day.getDayInGanZhi();
                    const cd = first_day.getSolar().subtract(mao_day.getSolar()) + 1;
                    const chuyigzyy = chuyigz ? constants.GAN_YIN_YANG[chuyigz[0]] : null;
                    const mgzyy = mgz ? constants.GAN_YIN_YANG[mgz[0]] : null;
                    
                    const cyxing = calculate_cyxing(mgzyy, cd);
                    const xingri = calculate_xingri(cyxing, chuyigzyy, days);
                    
                    if (czrx_num && xingri && xingri[czrx_num]) {
                        const target_days = xingri[czrx_num];
                        const day_str_list = [];
                        for (const day of target_days) {
                            if (typeof day !== 'number' || day < 1 || day > days) {
                                continue;
                            }
                            try {
                                const lunar_date = lunar.Lunar.fromYmd(year, month_for_date, day);
                                const day_gan_zhi = lunar_date.getDayInGanZhi();
                                const day_xingshi = calculate_xingshi(day_gan_zhi);
                                const jieqi = get_jieqi(lunar_date);
                                
                                let day_xf_info = null;
                                if (jieqi && day_gan_zhi) {
                                    day_xf_info = get_xingfang_info(jieqi, day_gan_zhi);
                                }
                                
                                day_str_list.push(`${day}${day_gan_zhi}`);
                                cxingzhiri_detail[day] = {
                                    gz: day_gan_zhi,
                                    xingshi: day_xingshi,
                                    jieqi: jieqi,
                                    xf: day_xf_info
                                };
                            } catch (e) {
                                continue;
                            }
                        }
                        cxingzhiri = day_str_list.join(' ') || null;
                    }
                }
            } catch (e) {
                // 忽略错误
            }
            
            const czhishi = {};
            if (czsx_num && Object.keys(cxingzhiri_detail).length > 0) {
                for (const [day, detail] of Object.entries(cxingzhiri_detail)) {
                    if (detail.xingshi && detail.xingshi[czsx_num]) {
                        czhishi[day] = detail.xingshi[czsx_num].join('');
                    } else {
                        czhishi[day] = '';
                    }
                }
            }
            
            let yueajs = null;
            if (whajs && month >= 1 && month <= 12) {
                const month_key = constants.MONTH_KEYS[month - 1];
                yueajs = whajs[month_key];
            }
            
            const bg_lines = [`农历${year}年${month}月`];
            if (czsx) {
                bg_lines.push(`${czrx}值日${czsx}值时的时间有：`);
            } else {
                bg_lines.push(`${czrx}值日的时间有：`);
            }
            
            if (Object.keys(cxingzhiri_detail).length > 0) {
                const sorted_days = Object.keys(cxingzhiri_detail).map(Number).sort((a, b) => a - b);
                for (const day of sorted_days) {
                    const detail = cxingzhiri_detail[day];
                    const shi = czhishi[day] || '';
                    const jieqi = detail.jieqi ? `【节气：${detail.jieqi}】` : '';
                    
                    let xingf_info = '';
                    if (detail.xf && detail.xf.xingf) {
                        const xingf_dict = detail.xf.xingf;
                        xingf_info = ' ' + Object.entries(xingf_dict).map(([gong, xing]) => `${gong}${xing}`).join('  ');
                    }
                    
                    if (czsx) {
                        bg_lines.push(`${day}号${detail.gz}日 ${jieqi} ${czrx}(${czrx_num})值日 ${shi}时${czsx}(${czsx_num})值时${xingf_info}`);
                    } else {
                        bg_lines.push(`${day}号${detail.gz}日 ${jieqi} ${czrx}(${czrx_num})值日${xingf_info}`);
                    }
                }
            }
            
            if (yueajs) {
                bg_lines.push(`月暗建煞：${yueajs}`);
            }
            
            const bg = bg_lines.join('\n');
            
            return {
                cxingzhiri: cxingzhiri,
                czhishi: Object.keys(czhishi).length > 0 ? czhishi : null,
                yueajs: yueajs,
                bg: bg
            };
        }
        
        function process_chaxun(cn, cy, czrx, czsx, whajs, shaf, current_lunar_year, month_value, is_leap_month) {
            const current_month_info = calculate_month_info(
                current_lunar_year,
                month_value,
                is_leap_month,
                czrx,
                czsx,
                whajs,
                shaf
            );
            
            const next_months_info = [];
            
            let next_month = month_value + 1;
            let next_year = current_lunar_year;
            if (next_month > 12) {
                next_month = 1;
                next_year += 1;
            }
            
            let next_is_leap = false;
            try {
                lunar.Lunar.fromYmd(next_year, next_month, 1, false);
                next_is_leap = false;
            } catch (e) {
                try {
                    lunar.Lunar.fromYmd(next_year, next_month, 1, true);
                    next_is_leap = true;
                } catch (e) {
                    next_is_leap = false;
                }
            }
            
            const next_month_info = calculate_month_info(
                next_year,
                next_month,
                next_is_leap,
                czrx,
                czsx,
                whajs,
                shaf
            );
            next_months_info.push(next_month_info);
            
            let third_month = next_month + 1;
            let third_year = next_year;
            if (third_month > 12) {
                third_month = 1;
                third_year += 1;
            }
            
            let third_is_leap = false;
            try {
                lunar.Lunar.fromYmd(third_year, third_month, 1, false);
                third_is_leap = false;
            } catch (e) {
                try {
                    lunar.Lunar.fromYmd(third_year, third_month, 1, true);
                    third_is_leap = true;
                } catch (e) {
                    third_is_leap = false;
                }
            }
            
            const third_month_info = calculate_month_info(
                third_year,
                third_month,
                third_is_leap,
                czrx,
                czsx,
                whajs,
                shaf
            );
            next_months_info.push(third_month_info);
            
            const all_bg_lines = [
                current_month_info.bg,
                '\n--- 后一个月 ---',
                next_months_info[0].bg,
                '\n--- 后两个月 ---',
                next_months_info[1].bg
            ];
            const combined_bg = all_bg_lines.join('\n');
            
            return {
                current_month: current_month_info,
                next_months: next_months_info,
                shaf: {
                    dtjs: shaf.dtjs,
                    jidt: shaf.jidt,
                    lishi: shaf.lishi,
                    wudt: shaf.wudt
                },
                bg: combined_bg
            };
        }
        
        function calculate(input_data) {
            try {
                const now = new Date();
                const now_solar = lunar.Solar.fromDate(now);
                const now_lunar = now_solar.getLunar();
                const current_lunar_year = now_lunar.getYear();
                const current_lunar_month = now_lunar.getMonth();
                const is_leap_month = current_lunar_month < 0;
                const month_value = Math.abs(current_lunar_month);
                
                const use_cn_cy = input_data.cn !== undefined && input_data.cy !== undefined;
                const nian = use_cn_cy ? input_data.cn : (input_data.nian || current_lunar_year);
                const yue = use_cn_cy ? input_data.cy : (input_data.yue || month_value);
                
                if (typeof nian !== 'number' || nian < 1900 || nian > 2100) {
                    throw new Error('年份必须是1900-2100之间的整数');
                }
                if (typeof yue !== 'number' || yue < 1 || yue > 12) {
                    throw new Error('月份必须是1-12之间的整数');
                }
                
                let chuyigz, mgz, cd, chuyigzyy, mgzyy, cyxing, yts, xingri;
                try {
                    const month_for_lunar = is_leap_month ? -month_value : month_value;
                    const first_day = lunar.Lunar.fromYmd(nian, month_for_lunar, 1);
                    const mao_day = find_last_mao_day(first_day);
                    chuyigz = first_day.getDayInGanZhi();
                    mgz = mao_day.getDayInGanZhi();
                    cd = first_day.getSolar().subtract(mao_day.getSolar()) + 1;
                    chuyigzyy = chuyigz ? constants.GAN_YIN_YANG[chuyigz[0]] : null;
                    mgzyy = mgz ? constants.GAN_YIN_YANG[mgz[0]] : null;
                    cyxing = calculate_cyxing(mgzyy, cd);
                    const lunar_month_obj = lunar.LunarYear.fromYear(nian).getMonth(month_for_lunar);
                    yts = lunar_month_obj ? lunar_month_obj.getDayCount() : null;
                    xingri = calculate_xingri(cyxing, chuyigzyy, yts);
                } catch (e) {
                    chuyigz = null;
                    mgz = null;
                    cd = null;
                    chuyigzyy = null;
                    mgzyy = null;
                    cyxing = null;
                    yts = null;
                    xingri = null;
                }
                
                let xingri_for_zhixing;
                try {
                    const current_month_for_lunar = is_leap_month ? -month_value : month_value;
                    const current_first_day = lunar.Lunar.fromYmd(current_lunar_year, current_month_for_lunar, 1);
                    const current_mao_day = find_last_mao_day(current_first_day);
                    const current_chuyigz = current_first_day.getDayInGanZhi();
                    const current_mgz = current_mao_day.getDayInGanZhi();
                    const current_cd = current_first_day.getSolar().subtract(current_mao_day.getSolar()) + 1;
                    const current_chuyigzyy = current_chuyigz ? constants.GAN_YIN_YANG[current_chuyigz[0]] : null;
                    const current_mgzyy = current_mgz ? constants.GAN_YIN_YANG[current_mgz[0]] : null;
                    const current_cyxing = calculate_cyxing(current_mgzyy, current_cd);
                    const current_lunar_month_obj = lunar.LunarYear.fromYear(current_lunar_year).getMonth(current_month_for_lunar);
                    const current_yts = current_lunar_month_obj ? current_lunar_month_obj.getDayCount() : null;
                    xingri_for_zhixing = calculate_xingri(current_cyxing, current_chuyigzyy, current_yts);
                } catch (e) {
                    xingri_for_zhixing = null;
                }
                
                const rz = now_lunar.getDayInGanZhi();
                const corrected_time = get_corrected_time(now);
                const corrected_solar = lunar.Solar.fromDate(corrected_time);
                const corrected_lunar = corrected_solar.getLunar();
                const sz = corrected_lunar.getTimeInGanZhi();
                const ke_result = calculate_ke_gan_zhi(corrected_lunar, now);
                const kz = ke_result.kz;
                const kezhi = ke_result.kezhi;
                const kg = ke_result.kg;
                
                const laibin_t = format_date(corrected_time);
                
                const shijian = {
                    bjs: now_solar.toYmd(),
                    nln: get_valid_number(current_lunar_year),
                    nly: get_valid_number(month_value),
                    yue: get_valid_number(Math.abs(current_lunar_month)),
                    ri: get_valid_number(now_lunar.getDay()),
                    nz: now_lunar.getYearInGanZhi(),
                    yz: now_lunar.getMonthInGanZhi(),
                    rz: rz,
                    sz: sz,
                    kz: kz,
                    kezhi: kezhi,
                    kg: kg
                };
                
                const xingshi = calculate_xingshi(rz);
                const xingke = calculate_xingke(sz);
                const jieqi = get_jieqi(now_solar) || get_jieqi(now_lunar);
                
                let zhixing = {};
                if (shijian.ri && xingri_for_zhixing) {
                    for (const [num, days] of Object.entries(xingri_for_zhixing)) {
                        if (days.includes(shijian.ri)) {
                            zhixing.zrx = constants.ZHIXING_MAP[num];
                            break;
                        }
                    }
                }
                
                if (xingshi && zhixing.zrx) {
                    const zrx_num = constants.XINGSHU_MAP[zhixing.zrx];
                    if (zrx_num && xingshi[zrx_num]) {
                        zhixing.zsx = constants.XINGSHU_REVERSE[zrx_num];
                    }
                }
                
                if (zhixing.zsx && xingke) {
                    const zsx_num = constants.XINGSHU_MAP[zhixing.zsx];
                    if (zsx_num && xingke[zsx_num]) {
                        zhixing.zzx = constants.XINGSHU_REVERSE[zsx_num];
                    }
                }
                
                const xf_info = get_xingfang_info(jieqi, rz);
                const tyty_info = get_tyty_info(jieqi);
                
                const dtjs_group = get_dtjs_group_by_gan(shijian.nz[0]);
                const lishi = calculate_lishi(shijian.nz);
                const whajs = calculate_whajs(shijian.nz);
                
                const shaf = {
                    dtjs: dtjs_group ? dtjs_group.join(' ') : null,
                    jidt: null,
                    lishi: lishi,
                    wudt: null
                };
                
                const guiren = calculate_all_guiren(shijian.nz, now_lunar);
                
                return {
                    shijian: shijian,
                    zhixing: zhixing,
                    xingshi: xingshi,
                    xingke: xingke,
                    xingfang: xf_info ? xf_info.xingfang : null,
                    xingf: xf_info ? xf_info.xingf : null,
                    taiyangdx: tyty_info ? tyty_info.taiyangdx : null,
                    taiyinds: tyty_info ? tyty_info.taiyinds : null,
                    jieqi: jieqi,
                    xingri: xingri,
                    laibin_t: laibin_t,
                    whajs: whajs,
                    shaf: shaf,
                    guiren: guiren
                };
            } catch (error) {
                console.error('计算出错:', error);
                return {
                    error: error.message,
                    shijian: null,
                    zhixing: null,
                    xingshi: null,
                    xingke: null,
                    xingfang: null,
                    xingf: null,
                    taiyangdx: null,
                    taiyinds: null,
                    jieqi: null,
                    xingri: null,
                    laibin_t: null,
                    whajs: null,
                    shaf: null,
                    guiren: null
                };
            }
        }
        
        // 查询函数
        function query() {
            const cn = parseInt(document.getElementById('cn').value);
            const cy = parseInt(document.getElementById('cy').value);
            const czrx = document.getElementById('czrx').value;
            
            if (!czrx) {
                alert('请选择值日星');
                return;
            }
            
            const input_data = {
                cn: cn,
                cy: cy
            };
            
            const result = calculate(input_data);
            
            if (result.error) {
                document.getElementById('xingriContent').innerHTML = `<div class="report-box">计算出错: ${result.error}</div>`;
                return;
            }
            
            const whajs = result.whajs;
            const shaf = result.shaf;
            const current_lunar_year = result.shijian.nln;
            const month_value = result.shijian.nly;
            const is_leap_month = result.shijian.nly < 0;
            
            const chaxun_result = process_chaxun(cn, cy, czrx, '', whajs, shaf, current_lunar_year, month_value, is_leap_month);
            
            document.getElementById('xingriContent').innerHTML = `<div class="report-box">${chaxun_result.bg}</div>`;
        }
        
        // 更新时间和页面信息
        function updateTimeAndInfo() {
            const now = new Date();
            const now_solar = lunar.Solar.fromDate(now);
            const now_lunar = now_solar.getLunar();
            
            // 更新系统时间
            const systemTimeElement = document.getElementById('systemTime');
            const laibinTimeElement = document.getElementById('laibinTime');
            
            const systemTime = now.toLocaleTimeString('zh-CN');
            systemTimeElement.textContent = systemTime;
            
            // 计算来宾时间
            const corrected_time = get_corrected_time(now);
            const laibinTime = corrected_time.toLocaleTimeString('zh-CN');
            laibinTimeElement.textContent = laibinTime;
            
            // 计算并更新页面信息
            const result = calculate({});
            
            if (!result.error) {
                // 更新农历信息
                const lunarTextElement = document.getElementById('lunarText');
                const jieqiTextElement = document.getElementById('jieqiText');
                
                const lunarYear = result.shijian.nln;
                const lunarMonth = result.shijian.nly;
                const lunarDay = result.shijian.ri;
                const lunarMonthStr = now_lunar.getMonth() < 0 ? '闰' + Math.abs(now_lunar.getMonth()) : now_lunar.getMonth();
                
                lunarTextElement.textContent = `${lunarYear}年${lunarMonthStr}月${lunarDay}日`;
                jieqiTextElement.textContent = result.jieqi || '';
                
                // 更新干支信息
                const ganzhiRowElement = document.getElementById('ganzhiRow');
                const ganzhiItems = ganzhiRowElement.querySelectorAll('.ganzhi-item');
                const ganzhiValues = [
                    result.shijian.nz,
                    result.shijian.yz,
                    result.shijian.rz,
                    result.shijian.sz,
                    result.shijian.kz
                ];
                
                ganzhiValues.forEach((value, index) => {
                    if (ganzhiItems[index]) {
                        ganzhiItems[index].textContent = value || '--';
                    }
                });
                
                // 更新值星信息
                const zhixingRowElement = document.getElementById('zhixingRow');
                zhixingRowElement.textContent = `值日星: ${result.zhixing.zrx || '--'} 值时星: ${result.zhixing.zsx || '--'} 值刻星: ${result.zhixing.zzx || '--'}`;
                
                // 更新星方信息
                const xfRowElement = document.getElementById('xfRow');
                if (result.xingfang) {
                    const xingfangText = Object.entries(result.xingfang).map(([dir, xing]) => `${dir}${xing}`).join(' ');
                    xfRowElement.textContent = xingfangText;
                } else {
                    xfRowElement.textContent = '-- --';
                }
                
                // 更新太阳太阴信息
                const tytyRowElement = document.getElementById('tytyRow');
                tytyRowElement.textContent = `${result.taiyangdx || '--'} ${result.taiyinds || '--'}`;
            }
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            // 初始更新
            updateTimeAndInfo();
            
            // 每秒更新一次时间
            setInterval(updateTimeAndInfo, 1000);
        };
