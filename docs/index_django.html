<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>天地玄妙 - 农历计算器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-image: url("backgrounds/background.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            margin: 0;
            padding: 0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        .container {
            width: 394px;
            height: 856px;
            margin: 20px auto;
            background: white;
            opacity: 0.68;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            z-index: 1;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border-radius: 20px;
        }
        
        /* 美化滚动条 */
        .container::-webkit-scrollbar {
            width: 4px;
        }
        
        .container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
        
        .container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 第一行：系统时间 */
        .time-row {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            gap: 31px;
        }
        
        .system-time {
            color: #d32f2f;
            font-weight: 600;
            font-size: 18px;
        }
        
        .laibin-time {
            color: #d32f2f;
            font-size: 14px;
        }
        
        /* 第二行：农历输出 */
        .lunar-row {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        
        .lunar-text {
            color: #333;
        }
        
        .jieqi-text {
            color: #1976d2;
            margin-left: 10px;
        }
        
        /* 第三行：干支 */
        .ganzhi-row {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 16px;
            font-size: 16px;
            color: #d32f2f;
            font-weight: 500;
            justify-content: center;
        }
        
        .ganzhi-item {
            flex: 0 0 auto;
            text-align: center;
        }
        
        /* 第四行：值星 */
        .zhixing-row {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        
        /* 第五行：输入区域 */
        .input-row {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .input-row input,
        .input-row select {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .query-btn {
            padding: 8px 16px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .query-btn:active {
            background: #1565c0;
        }
        
        /* 结果区域 */
        .result-area {
            padding: 20px;
            background: white;
        }
        
        .result-section {
            margin-bottom: 20px;
        }
        
        .result-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #333;
            padding-bottom: 8px;
            border-bottom: 2px solid #1976d2;
        }
        
        .result-item {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            color: #666;
            margin-right: 8px;
        }
        
        .result-value {
            color: #333;
            font-weight: 500;
        }
        
        .date-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #1976d2;
        }
        
        .date-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .date-detail {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .xingri-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .xingri-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .xingri-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 6px;
        }
        
        .xingri-days {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .report-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #4a90e2;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标题：天元乌兔择日 -->
        <div style="padding: 21px 20px 8px 20px; text-align: center; font-weight: bold; font-size: 20px; margin: 2px 0;">
            天元乌兔择日
        </div>
        
        <!-- 第一行：系统时间 -->
        <div class="time-row" style="padding: 5px 20px 8px 20px;">
            <span class="system-time" id="systemTime">--:--:--</span>
            <span class="laibin-time" id="laibinTime">--:--:--</span>
        </div>
        
        <!-- 第二行：农历输出 -->
        <div class="lunar-row">
            <span class="lunar-text" id="lunarText">加载中...</span>
            <span class="jieqi-text" id="jieqiText"></span>
        </div>
        
        <!-- 第三行：nz yz rz sz kz -->
        <div class="ganzhi-row" id="ganzhiRow">
            <div class="ganzhi-item">--</div>
            <div class="ganzhi-item">--</div>
            <div class="ganzhi-item">--</div>
            <div class="ganzhi-item">--</div>
            <div class="ganzhi-item">--</div>
        </div>
        
        <!-- 第四行：值日星 值时星 值刻星 -->
        <div class="zhixing-row" id="zhixingRow">
            值日星: -- 值时星: -- 值刻星: --
        </div>
        
        <!-- 第五行：星方星符信息 -->
        <div class="zhixing-row" id="xfRow">
            -- --
        </div>
        
        <!-- 第六行：太阳太阴到向到山 -->
        <div class="zhixing-row" id="tytyRow">
            -- --
        </div>
        
        <!-- 第七行：输入区域 -->
        <div class="input-row">
            <input type="number" id="cn" placeholder="年份">
            <input type="number" id="cy" placeholder="月份" min="1" max="12">
            <select id="czrx">
                <option value="">值日星</option>
                <option value="水星">水星</option>
                <option value="太阴">太阴</option>
                <option value="木星">木星</option>
                <option value="计都">计都</option>
                <option value="土星">土星</option>
                <option value="罗睺">罗睺</option>
                <option value="金星">金星</option>
                <option value="太阳">太阳</option>
                <option value="火星">火星</option>
            </select>
            <button class="query-btn" onclick="query()">查询</button>
        </div>
        
        <!-- 结果区域 -->
        <div class="result-area" id="resultArea">
            <div class="result-section">
                <div class="result-title">当月星日分布</div>
                <div id="xingriContent">加载中...</div>
            </div>
        </div>
    </div>
    
    <script>
        // 数字转中文
        const numToChinese = {
            0: '○', 1: '一', 2: '二', 3: '三', 4: '四', 5: '五', 6: '六', 7: '七', 8: '八', 9: '九', 10: '十'
        };
        
        const monthNames = ['', '正', '二', '三', '四', '五', '六', '七', '八', '九', '十', '十一', '腊'];
        
        function numberToChinese(num) {
            if (num < 10) return numToChinese[num];
            if (num < 20) return '十' + (num > 10 ? numToChinese[num % 10] : '');
            if (num < 100) {
                const tens = Math.floor(num / 10);
                const ones = num % 10;
                return numToChinese[tens] + '十' + (ones > 0 ? numToChinese[ones] : '');
            }
            // 处理年份
            const str = num.toString();
            return str.split('').map(d => numToChinese[parseInt(d)]).join('');
        }
        
        function formatLunarDate(year, month, day) {
            const yearStr = numberToChinese(year);
            const monthStr = monthNames[month] || month;
            let dayStr = '';
            if (day < 10) {
                dayStr = '初' + numToChinese[day];
            } else if (day === 10) {
                dayStr = '初十';
            } else if (day < 20) {
                dayStr = '十' + (day > 10 ? numToChinese[day % 10] : '');
            } else if (day === 20) {
                dayStr = '二十';
            } else if (day < 30) {
                dayStr = '二十' + numToChinese[day % 10];
            } else if (day === 30) {
                dayStr = '三十';
            } else {
                dayStr = '三十' + numToChinese[day % 10];
            }
            return `${yearStr}年${monthStr}月${dayStr}`;
        }
        
        function formatTimeOnly(timeStr) {
            if (!timeStr) return '--:--:--';
            // 从 "2026年01月23日 13:33:43" 提取时间部分
            const match = timeStr.match(/(\d{2}:\d{2}:\d{2})/);
            return match ? match[1] : '--:--:--';
        }
        
        function updateDisplay(data) {
            // 第一行：系统时间 + laibinT
            const now = new Date();
            const systemTime = now.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            });
            document.getElementById('systemTime').textContent = systemTime;
            document.getElementById('laibinTime').textContent = formatTimeOnly(data.laibinT);
            
            // 第二行：农历输出 + 节气
            if (data.shijian) {
                const lunarYear = data.shijian.nln;
                const lunarMonth = data.shijian.nly;
                const lunarDay = data.shijian.ri;
                if (lunarYear && lunarMonth && lunarDay) {
                    const lunarText = formatLunarDate(lunarYear, lunarMonth, lunarDay);
                    document.getElementById('lunarText').textContent = lunarText;
                }
            }
            if (data.jieqi) {
                document.getElementById('jieqiText').textContent = data.jieqi;
            }
            
            // 第三行：nz yz rz sz kz
            if (data.shijian) {
                const ganzhiItems = document.querySelectorAll('.ganzhi-item');
                ganzhiItems[0].textContent = data.shijian.nz || '--';
                ganzhiItems[1].textContent = data.shijian.yz || '--';
                ganzhiItems[2].textContent = data.shijian.rz || '--';
                ganzhiItems[3].textContent = data.shijian.sz || '--';
                ganzhiItems[4].textContent = data.shijian.kz || '--';
            }
            
            // 第四行：值日星 值时星 值刻星
            if (data.zhixing) {
                const zrx = data.zhixing.zrx || '--';
                const zsx = data.zhixing.zsx || '--';
                const zkx = data.zhixing.zkx || '--';
                document.getElementById('zhixingRow').innerHTML = `值日 ${zrx}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;值时 ${zsx}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;值刻 ${zkx}`;
            }
            
            // 第五行：星方星符信息
            if (data.xf) {
                let xingfText = '--';
                if (data.xf.xingf) {
                    xingfText = Object.entries(data.xf.xingf)
                        .map(([gong, xing]) => `${gong}${xing}`)
                        .join('  ');
                }
                document.getElementById('xfRow').innerHTML = xingfText;
            }
            
            // 第六行：太阳太阴到向到山
            if (data.tyty) {
                const taiyangdx = data.tyty.taiyangdx || '--';
                const taiyinds = data.tyty.taiyinds || '--';
                document.getElementById('tytyRow').innerHTML = `${taiyangdx} ${taiyinds}`;
            }
        }
        
        function displayXingri(xingri) {
            if (!xingri || Object.keys(xingri).length === 0) {
                document.getElementById('xingriContent').innerHTML = '<div class="result-item">暂无数据</div>';
                return;
            }
            
            const xingNames = {1: '水星', 2: '太阴', 3: '木星', 4: '计都', 5: '土星', 6: '罗睺', 7: '金星', 8: '太阳', 9: '火星'};
            let html = '<div class="xingri-grid">';
            
            for (const [num, days] of Object.entries(xingri)) {
                if (days && Array.isArray(days) && days.length > 0) {
                    html += `
                        <div class="xingri-card">
                            <div class="xingri-label">${xingNames[num] || num}星</div>
                            <div class="xingri-days">${days.join(', ')}日</div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            document.getElementById('xingriContent').innerHTML = html;
        }
        
        function displayQueryResult(data) {
            const resultArea = document.getElementById('resultArea');
            let html = '';
            
            // 查询结果：bg shaf lishi 等内容
            if (data.chaxun) {
                // 详细报告 (bg)
                if (data.chaxun.bg) {
                    html += '<div class="result-section">';
                    html += '<div class="result-title">详细报告</div>';
                    html += '<div class="report-box">' + data.chaxun.bg.replace(/\n/g, '<br>') + '</div>';
                    html += '</div>';
                }
                
                // 煞方信息
                if (data.chaxun.shaf) {
                    html += '<div class="result-section">';
                    html += '<div class="result-title">煞方信息</div>';
                    if (data.chaxun.shaf.wudt) {
                        html += '<div class="result-item"><span class="result-label">戊都天:</span><span class="result-value">' + data.chaxun.shaf.wudt + '</span></div>';
                    }
                    if (data.chaxun.shaf.jidt) {
                        html += '<div class="result-item"><span class="result-label">己都天:</span><span class="result-value">' + data.chaxun.shaf.jidt + '</span></div>';
                    }
                    if (data.chaxun.shaf.dtjs) {
                        html += '<div class="result-item"><span class="result-label">都天夹煞:</span><span class="result-value">' + data.chaxun.shaf.dtjs + '</span></div>';
                    }
                    if (data.chaxun.shaf.lishi) {
                        html += '<div class="result-item"><span class="result-label">力士:</span><span class="result-value">' + data.chaxun.shaf.lishi + '</span></div>';
                    }
                    html += '</div>';
                }
                
                // 月暗建煞
                if (data.chaxun.yueajs) {
                    html += '<div class="result-section">';
                    html += '<div class="result-title">月暗建煞</div>';
                    html += '<div class="result-item"><span class="result-value">' + data.chaxun.yueajs + '</span></div>';
                    html += '</div>';
                }
                
                // 星值日时
                if (data.chaxun.cxingzhiri) {
                    html += '<div class="result-section">';
                    html += '<div class="result-title">星值日时</div>';
                    html += '<div class="result-item"><span class="result-value">' + data.chaxun.cxingzhiri + '</span></div>';
                    html += '</div>';
                }
            }
            
            resultArea.innerHTML = html;
        }
        
        async function loadCurrentTime() {
            try {
                const response = await fetch('http://127.0.0.1:8000/api/lunar/calculate');
                const data = await response.json();
                
                if (data.message && data.message.includes('失败')) {
                    console.error('加载失败:', data.message);
                    return;
                }
                
                updateDisplay(data);
                
                // 如果没有查询输入，显示当前月的 xingri
                if (data.xingri) {
                    displayXingri(data.xingri);
                }
            } catch (error) {
                console.error('请求失败:', error);
            }
        }
        
        async function query() {
            const cn = document.getElementById('cn').value;
            const cy = document.getElementById('cy').value;
            const czrx = document.getElementById('czrx').value;
            
            if (!cn || !cy || !czrx) {
                alert('请输入年份、月份和值日星');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    cn: cn,
                    cy: cy,
                    czrx: czrx
                });
                const response = await fetch(`http://127.0.0.1:8000/api/lunar/calculate?${params.toString()}`);
                const data = await response.json();
                
                if (data.message && data.message.includes('失败')) {
                    alert(data.message);
                    return;
                }
                
                updateDisplay(data);
                displayQueryResult(data);
            } catch (error) {
                alert('查询失败: ' + error.message);
            }
        }
        
        // 页面加载时自动加载当前时间
        window.onload = function() {
            loadCurrentTime();
            
            // 每秒更新系统时间
            setInterval(function() {
                const now = new Date();
                const systemTime = now.toLocaleString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: false
                });
                document.getElementById('systemTime').textContent = systemTime;
            }, 1000);
        };
    </script>
</body>
</html>
