<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>天地玄妙</title>
    <!-- 引入lunar-javascript库 -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.1/lunar.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-image: url('https://img.51miz.com/preview/element/00/00/23/04/E-230486-2FC04154.jpg!middle');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .current-info {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .xing-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .xing-item {
            text-align: center;
        }
        
        .xing-label {
            font-size: 12px;
            color: #666;
        }
        
        .xing-value {
            font-size: 16px;
            font-weight: bold;
            color: #3498db;
        }
        
        .input-section {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .input-group {
            flex: 1;
            min-width: 80px;
        }
        
        .input-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        select, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            font-size: 14px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 0;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .result-section {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .result-item h3 {
            font-size: 16px;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .result-content {
            font-size: 14px;
            line-height: 1.8;
        }
        
        .result-line {
            margin-bottom: 5px;
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(52, 152, 219, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(52, 152, 219, 0.8);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>天地玄妙</h1>
        
        <div class="current-info">
            <div class="xing-info">
                <div class="xing-item">
                    <div class="xing-label">值日星</div>
                    <div class="xing-value" id="currentZrx">火星</div>
                </div>
                <div class="xing-item">
                    <div class="xing-label">值时星</div>
                    <div class="xing-value" id="currentZsx">罗睺</div>
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="input-row">
                <div class="input-group">
                    <select id="yearSelect">
                        <!-- 年份选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                <div class="input-group">
                    <select id="monthSelect">
                        <!-- 月份选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                <div class="input-group">
                    <select id="starSelect">
                        <!-- 值星选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                <div class="input-group">
                    <button id="queryBtn">查询</button>
                </div>
            </div>
        </div>
        
        <div class="result-section">
            <div id="result"></div>
        </div>
    </div>
    
    <script>
        // 修复lunar-javascript库的全局对象引用
        let Solar, Lunar;
        // 等待文档加载完成后初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 确保lunar-javascript库正确加载
            if (typeof window.lunar !== 'undefined') {
                if (typeof window.lunar.Solar !== 'undefined') {
                    Solar = window.lunar.Solar;
                    Lunar = window.lunar.Lunar;
                } else if (typeof window.lunar.fromYmd !== 'undefined') {
                    // 处理不同版本的库结构
                    Lunar = window.lunar;
                    Solar = window.solar || window.Solar;
                }
            } else if (typeof window.Solar !== 'undefined') {
                Solar = window.Solar;
                Lunar = window.Lunar;
            } else {
                console.error('lunar-javascript库未正确加载');
                return;
            }
        
        // 星数映射
        const xingshu = {
            1: '水星', 2: '太阴', 3: '木星', 4: '计都', 5: '土星',
            6: '罗睺', 7: '金星', 8: '太阳', 9: '火星'
        };
        
        // 星数反向映射
        const xingshuReverse = {
            '水星': 1, '太阴': 2, '木星': 3, '计都': 4, '土星': 5,
            '罗睺': 6, '金星': 7, '太阳': 8, '火星': 9
        };
        
        // 初始化年、月、值星下拉框
        function initSelects() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            const starSelect = document.getElementById('starSelect');
            
            // 当前年份
            const currentYear = new Date().getFullYear();
            
            // 添加年份选项（当前年份前后5年）
            // 选项格式：年YYYY
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `年${year}`;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // 添加月份选项
            // 选项格式：月MM
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `月${month}`;
                if (month === new Date().getMonth() + 1) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            }
            
            // 清空并重新添加值星选项
            starSelect.innerHTML = '';
            // 选项格式：值日XX
            const starOptions = ['水星', '太阴', '木星', '计都', '土星', '罗睺', '金星', '太阳', '火星'];
            for (const star of starOptions) {
                const option = document.createElement('option');
                option.value = star;
                option.textContent = `值日${star}`;
                if (star === '水星') {
                    option.selected = true;
                }
                starSelect.appendChild(option);
            }
        }
        
        // 查找目标日期之前最近的地支为卯的日期
        function getMaodayBeforeDate(targetLunar) {
            try {
                // 转换为公历日期
                const solar = targetLunar.getSolar();
                const targetSolarDate = new Date(solar.getYear(), solar.getMonth() - 1, solar.getDay());
                
                // 往前查找最多12天（一个地支周期）
                for (let daysBefore = 1; daysBefore <= 12; daysBefore++) {
                    try {
                        // 计算目标日期之前的日期
                        const prevSolarDate = new Date(targetSolarDate);
                        prevSolarDate.setDate(targetSolarDate.getDate() - daysBefore);
                        
                        // 创建公历对象并转换为农历
                        const prevSolar = Solar.fromYmd(
                            prevSolarDate.getFullYear(), prevSolarDate.getMonth() + 1, prevSolarDate.getDate()
                        );
                        const prevLunar = prevSolar.getLunar();
                        
                        // 获取该日期的干支并检查地支是否为卯
                        const dayGanzhi = prevLunar.getDayInGanZhi();
                        if (dayGanzhi.length >= 2 && dayGanzhi.charAt(1) === '卯') {
                            return prevLunar;
                        }
                    } catch (e) {
                        console.log(`检查第${daysBefore}天出错: ${e}，继续查找...`);
                        continue;
                    }
                }
            } catch (e) {
                console.log(`查找卯日时出错: ${e}`);
            }
            
            return null;
        }
        
        // 计算两个农历日期之间的天数，包括两头
        function countDaysBetween(maoday, firstDay) {
            try {
                // 获取两个日期的公历信息
                const maodaySolar = maoday.getSolar();
                const firstDaySolar = firstDay.getSolar();
                
                // 构建Date对象
                const maodayDate = new Date(maodaySolar.getYear(), maodaySolar.getMonth() - 1, maodaySolar.getDay());
                const firstDayDate = new Date(firstDaySolar.getYear(), firstDaySolar.getMonth() - 1, firstDaySolar.getDay());
                
                // 计算日期差（包含两头）
                const delta = firstDayDate - maodayDate;
                return Math.floor(delta / (1000 * 60 * 60 * 24)) + 1;
            } catch (e) {
                console.log(`计算日期差出错: ${e}`);
                return 0;
            }
        }
        
        // 根据用户定义的规则判断干支的阴阳属性
        function getGanzhiYinyang(ganzhi) {
            try {
                if (!ganzhi || ganzhi.length === 0) {
                    throw new Error("干支不能为空");
                }
                
                // 提取天干（干支第一个字）
                const gan = ganzhi.charAt(0);
                const yangGans = ['甲', '己', '丁', '壬', '戊', '癸'];
                const yinGans = ['乙', '庚', '丙', '辛'];
                
                if (yangGans.includes(gan)) {
                    return '阳';
                } else if (yinGans.includes(gan)) {
                    return '阴';
                } else {
                    return '未知';
                }
            } catch (e) {
                console.log(`计算干支阴阳属性时出错: ${e}`);
                return '未知';
            }
        }
        
        // 计算星势
        function calculateXingshi(ganzhi) {
            // 定义七星规则
            const qixing = {
                '甲己': '123456789',
                '乙庚': '765432198',
                '丙辛': '321987654',
                '丁壬': '912345678',
                '戊癸': '567891234'
            };
            
            // 十二地支
            const dizhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            
            try {
                // 提取日干支的天干
                if (!ganzhi || ganzhi.length === 0) {
                    throw new Error("日干支不能为空");
                }
                const gan = ganzhi.charAt(0);
                
                // 确定属于哪个七星组合
                let qixingKey = null;
                if (gan === '甲' || gan === '己') {
                    qixingKey = '甲己';
                } else if (gan === '乙' || gan === '庚') {
                    qixingKey = '乙庚';
                } else if (gan === '丙' || gan === '辛') {
                    qixingKey = '丙辛';
                } else if (gan === '丁' || gan === '壬') {
                    qixingKey = '丁壬';
                } else if (gan === '戊' || gan === '癸') {
                    qixingKey = '戊癸';
                }
                
                if (!qixingKey) {
                    return null;
                }
                
                // 获取对应的数组并生成星势字典
                const qixingArray = qixing[qixingKey];
                const xingshi = {};
                for (let i = 0; i < dizhi.length; i++) {
                    const num = qixingArray.charAt(i % qixingArray.length);
                    if (!xingshi[num]) {
                        xingshi[num] = [];
                    }
                    xingshi[num].push(dizhi[i]);
                }
                
                return xingshi;
            } catch (e) {
                console.log(`计算星势出错: ${e}`);
                return null;
            }
        }
        
        // 计算力士方位
        function calculateLishi(nianGanzhi) {
            try {
                // 力士方位映射
                const lishiFangweiMap = {
                    '子': '艮', '丑': '艮', '寅': '巽', '卯': '巽', '辰': '巽',
                    '巳': '坤', '午': '坤', '未': '坤', '申': '乾', '酉': '乾',
                    '戌': '乾', '亥': '艮'
                };
                
                if (nianGanzhi.length < 2) {
                    throw new Error("年干支格式错误，需包含年干和年支");
                }
                const nianZhi = nianGanzhi.charAt(1);
                
                if (lishiFangweiMap[nianZhi]) {
                    return `lishi：${nianZhi}年力士在${lishiFangweiMap[nianZhi]}方`;
                } else {
                    return null;
                }
            } catch (e) {
                console.log(`计算力士信息出错: ${e}`);
                return null;
            }
        }
        
        // 计算暗建煞
        function calculateWhajs(nianGanzhi) {
            try {
                // 暗建煞规则
                const anjian1Map = {
                    '子午卯酉': '坤震巽中乾兑艮离坎坤震巽',
                    '寅申巳亥': '艮离坎坤震巽中乾兑艮离坎',
                    '辰戌丑未': '中乾兑艮离坎坤震巽中乾兑'
                };
                
                // 月份信息
                const yueInfo = {
                    1: {name: 'yi', chinese: '一月'}, 
                    2: {name: 'er', chinese: '二月'},
                    3: {name: 'san', chinese: '三月'}, 
                    4: {name: 'si', chinese: '四月'},
                    5: {name: 'wu', chinese: '五月'}, 
                    6: {name: 'liu', chinese: '六月'},
                    7: {name: 'qi', chinese: '七月'}, 
                    8: {name: 'ba', chinese: '八月'},
                    9: {name: 'jiu', chinese: '九月'}, 
                    10: {name: 'shi', chinese: '十月'},
                    11: {name: 'shiyi', chinese: '十一月'}, 
                    12: {name: 'shier', chinese: '十二月'}
                };
                
                // 提取年支
                if (nianGanzhi.length < 2) {
                    throw new Error("年干支格式错误，需包含年干和年支");
                }
                const nianZhi = nianGanzhi.charAt(1);
                
                // 确定年支组别
                let group = '';
                if (['子', '午', '卯', '酉'].includes(nianZhi)) {
                    group = '子午卯酉';
                } else if (['寅', '申', '巳', '亥'].includes(nianZhi)) {
                    group = '寅申巳亥';
                } else if (['辰', '戌', '丑', '未'].includes(nianZhi)) {
                    group = '辰戌丑未';
                } else {
                    throw new Error(`不支持的年支：${nianZhi}`);
                }
                
                if (!anjian1Map[group]) {
                    throw new Error(`无对应暗建煞规则的组别：${group}`);
                }
                const fangweiStr = anjian1Map[group];
                
                // 生成暗建煞字典
                const anjianShaDict = {};
                for (let month = 1; month <= 12; month++) {
                    if (yueInfo[month] && (month - 1) < fangweiStr.length) {
                        const info = yueInfo[month];
                        anjianShaDict[info.name] = `${info.chinese}暗建煞在${fangweiStr.charAt(month - 1)}`;
                    }
                }
                
                return anjianShaDict;
            } catch (e) {
                console.log(`计算暗建煞出错: ${e}`);
                return null;
            }
        }
        
        // 计算都天夹煞
        function calculateDtjs(nianGanzhi) {
            try {
                // 都天夹煞规则
                const dtjsRules = {
                    '甲': ['辰', '巳', '巽'],
                    '己': ['辰', '巳', '巽'],
                    '乙': ['子寅', '丑卯', '甲'],
                    '庚': ['子寅', '丑卯', '甲'],
                    '丙': ['戌', '亥', '乾'],
                    '辛': ['戌', '亥', '乾'],
                    '丁': ['申', '酉', '庚'],
                    '壬': ['申', '酉', '庚'],
                    '戊': ['午', '未', '丁'],
                    '癸': ['午', '未', '丁']
                };
                
                // 提取年干
                if (nianGanzhi.length < 2) {
                    throw new Error("年干支格式错误，需包含年干和年支");
                }
                const nianGan = nianGanzhi.charAt(0);
                
                if (!dtjsRules[nianGan]) {
                    throw new Error(`不支持的年干：${nianGan}`);
                }
                
                // 获取对应规则
                const rule = dtjsRules[nianGan];
                const wudtFang = rule[0];
                const jidtFang = rule[1];
                const dtjsFang = rule[2];
                
                // 生成结果
                const wudt = `戊都天在${wudtFang}方`;
                const jidt = `巳都天在${jidtFang}方`;
                const dtjs = `都天夹煞在${dtjsFang}`;
                
                return {
                    wudt: wudt,
                    jidt: jidt,
                    dtjs: dtjs
                };
            } catch (e) {
                console.log(`计算都天夹煞出错: ${e}`);
                return null;
            }
        }
        
        // 处理单个月份，返回该月内匹配的日子
        function processSingleMonth(year, month, targetStarNum) {
            try {
                // 定义当月初一
                const currentFirstDay = Lunar.fromYmd(year, month, 1);
                
                // 计算当月总天数
                const nextMonth = month === 12 ? 1 : month + 1;
                const nextYear = month === 12 ? year + 1 : year;
                const nextFirstDay = Lunar.fromYmd(nextYear, nextMonth, 1);
                
                // 转换为公历计算天数差
                const currentSolar = currentFirstDay.getSolar();
                const nextSolar = nextFirstDay.getSolar();
                const currentDate = new Date(currentSolar.getYear(), currentSolar.getMonth() - 1, currentSolar.getDay());
                const nextDate = new Date(nextSolar.getYear(), nextSolar.getMonth() - 1, nextSolar.getDay());
                const totalDays = Math.floor((nextDate - currentDate) / (1000 * 60 * 60 * 24));
                
                // 初一干支信息
                const firstDayGanzhi = currentFirstDay.getDayInGanZhi();
                const firstDayYinyang = getGanzhiYinyang(firstDayGanzhi);
                
                // 查找初一前的卯日
                const maoday = getMaodayBeforeDate(currentFirstDay);
                if (!maoday) {
                    return [];
                }
                
                // 计算天数差
                const days = countDaysBetween(maoday, currentFirstDay);
                
                // 选择地支列表
                const yangDz = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
                const yinDz = ['子', '亥', '戌', '酉', '申', '未', '午', '巳', '辰', '卯', '寅', '丑'];
                const selectedDz = firstDayYinyang === '阳' ? yangDz : yinDz;
                
                // 获取对应地支值
                const index = days - 1;
                if (!(0 <= index && index < selectedDz.length)) {
                    return [];
                }
                
                const dzValue = selectedDz[index];
                
                // 查找星值对应的数字
                const xingzhi = {1: '子', 2: '未申', 3: '卯', 4: '辰巳', 6: '戌亥', 7: '酉', 8: '丑寅', 9: '午'};
                let xingzhiNum = null;
                for (const num in xingzhi) {
                    if (xingzhi[num].includes(dzValue)) {
                        xingzhiNum = parseInt(num);
                        break;
                    }
                }
                
                if (!xingzhiNum) {
                    return [];
                }
                
                // 选择九星数组
                const yangPsz = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                const yinPsz = [9, 8, 7, 6, 5, 4, 3, 2, 1];
                const selectedPsz = firstDayYinyang === '阳' ? yangPsz : yinPsz;
                
                // 查找起始索引
                const startIndex = selectedPsz.indexOf(xingzhiNum);
                if (startIndex === -1) {
                    return [];
                }
                
                // 生成每日九星映射
                const dayPszMap = {};
                for (let day = 1; day <= totalDays; day++) {
                    const currentIndex = (startIndex + day - 1) % selectedPsz.length;
                    const pszNum = selectedPsz[currentIndex];
                    if (!dayPszMap[pszNum]) {
                        dayPszMap[pszNum] = [];
                    }
                    dayPszMap[pszNum].push(day);
                }
                
                // 筛选符合目标星数的日子
                const matchedDays = [];
                if (dayPszMap[targetStarNum]) {
                    for (const day of dayPszMap[targetStarNum]) {
                        // 创建当日农历对象
                        const dayLunar = Lunar.fromYmd(year, month, day);
                        const ganzhi = dayLunar.getDayInGanZhi();
                        const solar = dayLunar.getSolar();
                        
                        // 格式化日期（使用农历日期）
                        const formattedDate = `${year}年${month}月${day}日（农历）`;
                        
                        // 计算相关信息
                        const nianGanzhi = dayLunar.getYearInGanZhi();
                        const lishi = calculateLishi(nianGanzhi);
                        const dtjs = calculateDtjs(nianGanzhi);
                        const whajsDict = calculateWhajs(nianGanzhi);
                        
                        // 获取当前月份的暗建煞
                        let whajs = "";
                        const yueOrder = ['yi', 'er', 'san', 'si', 'wu', 'liu', 'qi', 'ba', 'jiu', 'shi', 'shiyi', 'shier'];
                        if (whajsDict && whajsDict[yueOrder[month - 1]]) {
                            whajs = whajsDict[yueOrder[month - 1]];
                        }
                        
                        // 添加到结果列表
                        matchedDays.push({
                            date: formattedDate,
                            ganzhi: ganzhi,
                            star: xingshu[targetStarNum],
                            lishi: lishi,
                            dtjs: dtjs,
                            whajs: whajs
                        });
                    }
                }
                
                return matchedDays;
            } catch (e) {
                console.log(`分析月信息出错: ${e}`);
                return [];
            }
        }
        
        // 分析特定年月及随后两个月的星日信息
        function analyzeMonthDays(targetYear, targetMonth, targetStarNum) {
            try {
                // 处理连续三个月：当前月、下一个月、再下一个月
                const allMatchedDays = [];
                
                // 月份列表：当前月、下一个月、再下一个月
                for (let monthOffset = 0; monthOffset < 3; monthOffset++) {
                    // 计算当前处理的月份和年份
                    let currentProcessMonth = targetMonth + monthOffset;
                    let currentProcessYear = targetYear;
                    
                    // 处理月份进位
                    while (currentProcessMonth > 12) {
                        currentProcessMonth -= 12;
                        currentProcessYear += 1;
                    }
                    
                    // 处理该月份
                    const monthResult = processSingleMonth(currentProcessYear, currentProcessMonth, targetStarNum);
                    allMatchedDays.push(...monthResult);
                }
                
                return allMatchedDays;
            } catch (e) {
                console.log(`分析月信息出错: ${e}`);
                return [];
            }
        }
        
        // 获取当前时间的值日星和值时星
        function updateCurrentStars() {
            try {
                const now = new Date();
                const solar = Solar.fromYmd(now.getFullYear(), now.getMonth() + 1, now.getDate());
                const lunar = solar.getLunar();
                
                // 定义当月初一
                const currentFirstDay = Lunar.fromYmd(lunar.getYear(), lunar.getMonth(), 1);
                
                // 计算当月总天数
                const nextMonth = lunar.getMonth() === 12 ? 1 : lunar.getMonth() + 1;
                const nextYear = lunar.getMonth() === 12 ? lunar.getYear() + 1 : lunar.getYear();
                const nextFirstDay = Lunar.fromYmd(nextYear, nextMonth, 1);
                
                // 转换为公历计算天数差
                const currentSolar = currentFirstDay.getSolar();
                const nextSolar = nextFirstDay.getSolar();
                const currentDate = new Date(currentSolar.getYear(), currentSolar.getMonth() - 1, currentSolar.getDay());
                const nextDate = new Date(nextSolar.getYear(), nextSolar.getMonth() - 1, nextSolar.getDay());
                const totalDays = Math.floor((nextDate - currentDate) / (1000 * 60 * 60 * 24));
                
                // 初一干支信息
                const firstDayGanzhi = currentFirstDay.getDayInGanZhi();
                const firstDayYinyang = getGanzhiYinyang(firstDayGanzhi);
                
                // 查找初一前的卯日
                const maoday = getMaodayBeforeDate(currentFirstDay);
                if (maoday) {
                    // 计算天数差
                    const days = countDaysBetween(maoday, currentFirstDay);
                    
                    // 选择地支列表
                    const yangDz = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
                    const yinDz = ['子', '亥', '戌', '酉', '申', '未', '午', '巳', '辰', '卯', '寅', '丑'];
                    const selectedDz = firstDayYinyang === '阳' ? yangDz : yinDz;
                    
                    // 获取对应地支值
                    const index = days - 1;
                    if (0 <= index && index < selectedDz.length) {
                        const dzValue = selectedDz[index];
                        
                        // 查找星值对应的数字
                        const xingzhi = {1: '子', 2: '未申', 3: '卯', 4: '辰巳', 6: '戌亥', 7: '酉', 8: '丑寅', 9: '午'};
                        let xingzhiNum = null;
                        for (const num in xingzhi) {
                            if (xingzhi[num].includes(dzValue)) {
                                xingzhiNum = parseInt(num);
                                break;
                            }
                        }
                        
                        if (xingzhiNum) {
                            // 选择九星数组
                            const yangPsz = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                            const yinPsz = [9, 8, 7, 6, 5, 4, 3, 2, 1];
                            const selectedPsz = firstDayYinyang === '阳' ? yangPsz : yinPsz;
                            
                            // 查找起始索引
                            const startIndex = selectedPsz.indexOf(xingzhiNum);
                            if (startIndex !== -1) {
                                // 生成每日九星映射
                                const dayPszMap = {};
                                for (let day = 1; day <= totalDays; day++) {
                                    const currentIndex = (startIndex + day - 1) % selectedPsz.length;
                                    const pszNum = selectedPsz[currentIndex];
                                    if (!dayPszMap[pszNum]) {
                                        dayPszMap[pszNum] = [];
                                    }
                                    dayPszMap[pszNum].push(day);
                                }
                                
                                // 获取当前日
                                const currentDay = lunar.getDay();
                                
                                // 计算当前值日星
                                let zrx = '未知';
                                for (const pszNum in dayPszMap) {
                                    if (dayPszMap[pszNum].includes(currentDay)) {
                                        zrx = xingshu[parseInt(pszNum)];
                                        break;
                                    }
                                }
                                
                                // 更新显示
                                document.getElementById('currentZrx').textContent = zrx;
                            }
                        }
                    }
                }
                
                // 计算当前值时星
                const timeGanzhi = lunar.getTimeInGanZhi();
                const dayGanzhi = lunar.getDayInGanZhi();
                const dayXingshi = calculateXingshi(dayGanzhi);
                let zsx = '未知';
                if (dayXingshi) {
                    const timeZhi = timeGanzhi.charAt(timeGanzhi.length - 1);
                    for (const num in dayXingshi) {
                        if (dayXingshi[num].includes(timeZhi)) {
                            zsx = xingshu[parseInt(num)];
                            break;
                        }
                    }
                }
                
                // 更新显示
                document.getElementById('currentZsx').textContent = zsx;
            } catch (e) {
                console.log(`更新当前星信息出错: ${e}`);
            }
        }
        
        // 格式化结果显示
        function formatResult(days) {
            if (days.length === 0) {
                return '<div class="result-item"><h3>查询结果</h3><div class="result-content">未找到匹配的日期</div></div>';
            }
            
            let html = '';
            for (const day of days) {
                html += `<div class="result-item">
                    <h3>${day.date}</h3>
                    <div class="result-content">
                        <div class="result-line">干支：${day.ganzhi}</div>
                        <div class="result-line">值日星：${day.star}</div>
                        <div class="result-line">${day.lishi}</div>
                        <div class="result-line">都天信息</div>
                        <div class="result-line">${day.dtjs.wudt}</div>
                        <div class="result-line">${day.dtjs.jidt}</div>
                        <div class="result-line">${day.dtjs.dtjs}</div>
                        <div class="result-line">暗建煞</div>
                        <div class="result-line">${day.whajs}</div>
                    </div>
                </div>`;
            }
            
            return html;
        }
        
        // 查询按钮点击事件
        function handleQuery() {
            try {
                // 用户输入的年份和月份直接作为农历年月使用
                const lunarYear = parseInt(document.getElementById('yearSelect').value);
                const lunarMonth = parseInt(document.getElementById('monthSelect').value);
                const starName = document.getElementById('starSelect').value;
                const starNum = xingshuReverse[starName];
                
                // 分析月份天数（直接使用农历年月）
                const matchedDays = analyzeMonthDays(lunarYear, lunarMonth, starNum);
                
                // 格式化结果
                const resultHtml = formatResult(matchedDays);
                
                // 显示结果
                document.getElementById('result').innerHTML = resultHtml;
            } catch (e) {
                console.error('查询出错:', e);
                alert('查询出错: ' + e.message);
            }
        }
        
            // 初始化下拉框
            initSelects();
            
            // 更新当前星信息
            updateCurrentStars();
            
            // 绑定查询按钮事件
            document.getElementById('queryBtn').addEventListener('click', function() {
                try {
                    handleQuery();
                } catch (e) {
                    console.error('查询出错:', e);
                    document.getElementById('result').innerHTML = '<div style="color: red; text-align: center; padding: 20px;">查询出错，请稍后重试</div>';
                }
            });
            
            // 初始查询
            try {
                handleQuery();
            } catch (e) {
                console.error('初始查询出错:', e);
                document.getElementById('result').innerHTML = '<div style="color: red; text-align: center; padding: 20px;">查询出错，请稍后重试</div>';
            }
        });
    </script>
</body>
</html>
